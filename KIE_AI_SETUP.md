# Инструкция по настройке Kie.ai API

## Что изменилось

Бот теперь использует **Kie.ai API** для генерации видео через Grok Imagine вместо прямого использования Grok API от xAI.

### Архитектура:
- **Grok API (xAI)** - используется для анализа изображений (определение количества людей)
- **Kie.ai API** - используется для генерации видео из изображений

## Шаг 1: Получение API ключа от Kie.ai

1. Перейдите на https://kie.ai
2. Зарегистрируйтесь или войдите в аккаунт
3. Перейдите в раздел API Keys или Settings
4. Создайте новый API ключ
5. Скопируйте ключ (он понадобится для Railway)

## Шаг 2: Добавление переменных окружения в Railway

В Railway добавьте следующую переменную окружения:

### Новая переменная:
```
KIE_AI_API_KEY=ваш_ключ_от_kie_ai
```

### Существующие переменные (должны быть):
```
TELEGRAM_BOT_TOKEN=ваш_токен_telegram
GROK_API_KEY=ваш_ключ_grok_api
GROK_API_URL=https://api.x.ai/v1
KIE_AI_API_URL=https://api.kie.ai
LOG_LEVEL=INFO
MAX_FILE_SIZE_MB=10
VIDEO_DURATION_SECONDS=5
```

## Шаг 3: Как добавить переменные в Railway

1. Откройте ваш проект в Railway: https://railway.app
2. Выберите сервис (web)
3. Перейдите в раздел **Variables** (или **Settings** → **Variables**)
4. Нажмите **New Variable**
5. Добавьте:
   - **Name**: `KIE_AI_API_KEY`
   - **Value**: ваш API ключ от Kie.ai
6. Нажмите **Add**
7. Railway автоматически перезапустит сервис

## Шаг 4: Проверка работы

После добавления переменной окружения:

1. Railway автоматически перезапустит бота
2. Проверьте логи в Railway - не должно быть ошибок о missing KIE_AI_API_KEY
3. Откройте Telegram и найдите вашего бота
4. Отправьте фотографию с людьми
5. Бот должен обработать фотографию и сгенерировать видео

## Формат запроса к Kie.ai API

Бот использует асинхронный API с двумя этапами:

### Этап 1: Создание задачи
Endpoint: `POST https://api.kie.ai/api/v1/jobs/createTask`

Формат запроса:
```json
{
  "model": "grok-imagine/image-to-video",
  "input": {
    "image_urls": ["data:image/jpeg;base64,..."],
    "prompt": "Animate the people in this photo to kiss each other...",
    "mode": "spicy"
  }
}
```

Ответ содержит `task_id` для проверки статуса.

### Этап 2: Проверка статуса задачи
Endpoint: `GET https://api.kie.ai/api/v1/jobs/queryTask?task_id={task_id}`

Бот автоматически опрашивает статус задачи каждые 5 секунд до завершения.

## Возможные проблемы

### Ошибка: Missing KIE_AI_API_KEY
- **Решение**: Убедитесь, что переменная добавлена в Railway Variables
- Проверьте правильность написания имени переменной (должно быть `KIE_AI_API_KEY`)

### Ошибка: 401 Unauthorized
- **Решение**: Проверьте правильность API ключа от Kie.ai
- Убедитесь, что ключ активен и не истек

### Ошибка: 400 Bad Request
- **Решение**: Проверьте формат изображения (должен быть JPEG или PNG)
- Проверьте размер файла (максимум 10MB)

### Ошибка: Rate limit exceeded
- **Решение**: Подождите несколько минут и попробуйте снова
- Проверьте лимиты вашего тарифа на Kie.ai

## Дополнительная информация

### Режимы генерации (mode):
- `normal` - стандартный режим (используется по умолчанию)
- `fun` - более креативный режим
- `spicy` - доступен только для изображений, сгенерированных через Kie.ai

### Ограничения:
- Максимальный размер файла: 10MB
- Поддерживаемые форматы: JPEG, PNG, WEBP
- Максимум 1 изображение на запрос (для двух фотографий используется первая)

## Стоимость

Проверьте тарифы на https://kie.ai для информации о стоимости использования API.

## Поддержка

Если возникли проблемы:
1. Проверьте логи в Railway
2. Проверьте документацию Kie.ai: https://kie.ai/grok-imagine
3. Убедитесь, что все переменные окружения настроены правильно

